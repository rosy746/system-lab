<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Komputer 8 - Internet Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .server-status {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .server-status.connected {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .server-status.disconnected {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .status-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 15px;
        }

        .tab {
            flex: 1;
            padding: 15px 25px;
            background: rgba(255,255,255,0.5);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #333;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.7);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .control-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .control-title {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
        }

        .status-badge.online {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.offline {
            background: #ffebee;
            color: #c62828;
        }

        .status-badge.checking {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-badge.error {
            background: #f5f5f5;
            color: #757575;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-badge.online .status-dot {
            background: #4caf50;
        }

        .status-badge.offline .status-dot {
            background: #f44336;
        }

        .status-badge.checking .status-dot {
            background: #ff9800;
        }

        .status-badge.error .status-dot {
            background: #9e9e9e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 25px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-family: inherit;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-on {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-on:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-off {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-off:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .btn-devices {
            background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            grid-column: 1 / -1;
        }

        .btn-devices:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .lab-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .devices-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .devices-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .devices-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 150px;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            min-width: 300px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f093fb;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #333;
            font-weight: 600;
            font-size: 18px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 10000;
            min-width: 350px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.active {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid #4caf50;
        }

        .toast.error {
            border-left: 4px solid #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 28px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .toast-message {
            color: #666;
            font-size: 14px;
        }

        .toast-close {
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }

        .toast-close:hover {
            color: #333;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .header p {
                font-size: 14px;
            }

            .server-status {
                padding: 15px;
                gap: 10px;
            }

            .status-item {
                min-width: calc(50% - 5px);
            }

            .status-label {
                font-size: 10px;
            }

            .status-value {
                font-size: 16px;
            }

            .tab {
                padding: 12px 15px;
                font-size: 14px;
            }

            .control-card {
                padding: 25px 20px;
            }

            .control-title {
                font-size: 20px;
            }

            .button-group {
                gap: 15px;
            }

            .btn {
                padding: 18px 20px;
                font-size: 15px;
            }

            .lab-info {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }

            .devices-panel {
                padding: 20px 15px;
            }

            .stat-card {
                min-width: auto;
            }

            .stat-value {
                font-size: 28px;
            }

            .toast {
                left: 10px;
                right: 10px;
                bottom: 10px;
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .control-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .status-badge {
                align-self: flex-start;
            }

            .button-group {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .btn-devices {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè´ Lab Komputer 8</h1>
            <p>Internet Access Control Dashboard</p>
        </div>
        
        <!-- Server Status -->
        <div class="server-status" id="serverStatus">
            <div class="status-item">
                <div class="status-label">Status Koneksi</div>
                <div class="status-value" id="serverStatusText">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Status Lab</div>
                <div class="status-value" id="labStatusText">-</div>
            </div>
            <div class="status-item">
                <div class="status-label">Total Devices</div>
                <div class="status-value" id="deviceCountStatus">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('control')">üéÆ Control Panel</button>
            <button class="tab" onclick="switchTab('devices')">üì± Devices Monitor</button>
        </div>

        <!-- Control Panel Tab -->
        <div id="tab-control" class="tab-content active">
            <div class="control-card">
                <div class="control-header">
                    <div class="control-title">üåê Internet Control</div>
                    <div class="status-badge checking" id="status-lab">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking...</span>
                    </div>
                </div>
                
                <div class="button-group">
                    <button onclick="toggleInternet('on')" class="btn btn-on" id="btn-on">
                        <span style="font-size: 24px;">üü¢</span>
                        <span>Hidupkan Internet</span>
                    </button>
                    <button onclick="toggleInternet('off')" class="btn btn-off" id="btn-off">
                        <span style="font-size: 24px;">üî¥</span>
                        <span>Matikan Internet</span>
                    </button>
                    <button onclick="switchTab('devices')" class="btn btn-devices" id="btn-devices">
                        <span style="font-size: 24px;">üì±</span>
                        <span>Lihat Devices (<span id="device-count">0</span>)</span>
                    </button>
                </div>
                
                <div class="lab-info">
                    <div class="info-item">
                        <div class="info-label">Status Internet</div>
                        <div class="info-value" id="internet-status">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Devices Aktif</div>
                        <div class="info-value" id="active-devices-info">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Last Update</div>
                        <div class="info-value" id="last-update">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Devices Monitor Tab -->
        <div id="tab-devices" class="tab-content">
            <div class="devices-panel">
                <div class="devices-header">
                    <div class="devices-title">üì± Connected Devices</div>
                    <button class="btn btn-devices" onclick="loadDevices()" style="padding: 15px 25px; font-size: 15px;">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="devices-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-devices">0</div>
                        <div class="stat-label">Total Devices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-active">0</div>
                        <div class="stat-label">Active Devices</div>
                    </div>
                </div>

                <div id="devices-list">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Mengirim perintah...</div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚úÖ</span>
        <div class="toast-content">
            <div class="toast-title" id="toastTitle">Berhasil</div>
            <div class="toast-message" id="toastMessage">Pesan</div>
        </div>
        <span class="toast-close" onclick="hideToast()">√ó</span>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const CONFIG = {
            LAB_ID: 2,
            LAB_NAME: 'Lab Komputer 8',
            PYTHON_SERVER_URL: '/api',
            CHECK_INTERVAL: 30000,
            REQUEST_TIMEOUT: 10000,
            MAX_RETRIES: 3
        };

        // ==========================================
        // STATE
        // ==========================================
        const AppState = {
            isServerConnected: false,
            retryCount: 0,
            currentTab: 'control'
        };

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        
        function safeGetElement(id) {
            const el = document.getElementById(id);
            if (!el) console.warn(`Element not found: ${id}`);
            return el;
        }

        async function fetchWithTimeout(url, options = {}, timeout = CONFIG.REQUEST_TIMEOUT) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout');
                }
                throw error;
            }
        }

        function updateServerConnection(isConnected) {
            AppState.isServerConnected = isConnected;
            const statusEl = safeGetElement('serverStatus');
            const textEl = safeGetElement('serverStatusText');
            
            if (!statusEl || !textEl) return;
            
            if (isConnected) {
                statusEl.className = 'server-status connected';
                textEl.textContent = '‚úÖ Terhubung';
            } else {
                statusEl.className = 'server-status disconnected';
                textEl.textContent = '‚ùå Terputus';
            }
        }

        function showToast(title, message, type = 'success') {
            const toast = safeGetElement('toast');
            const icon = safeGetElement('toastIcon');
            const titleEl = safeGetElement('toastTitle');
            const msgEl = safeGetElement('toastMessage');

            if (!toast || !icon || !titleEl || !msgEl) return;

            const config = {
                success: { icon: '‚úÖ' },
                error: { icon: '‚ùå' }
            };

            icon.textContent = config[type]?.icon || '‚úÖ';
            titleEl.textContent = title;
            msgEl.textContent = message;
            
            toast.className = `toast active ${type}`;
            setTimeout(() => hideToast(), 5000);
        }

        function hideToast() {
            const toast = safeGetElement('toast');
            if (toast) toast.classList.remove('active');
        }

        function showLoading(message = 'Mengirim perintah...') {
            const overlay = safeGetElement('loadingOverlay');
            const text = safeGetElement('loadingText');
            
            if (overlay) overlay.classList.add('active');
            if (text) text.textContent = message;
        }

        function hideLoading() {
            const overlay = safeGetElement('loadingOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        function updateStatus(status) {
            const statusEl = safeGetElement('status-lab');
            const lastUpdateEl = safeGetElement('last-update');
            const labStatusEl = safeGetElement('labStatusText');
            const internetStatusEl = safeGetElement('internet-status');
            
            if (!statusEl) return;
            
            const textEl = statusEl.querySelector('.status-text');
            if (!textEl) return;
            
            statusEl.className = `status-badge ${status}`;
            
            const statusText = {
                online: 'Aktif',
                offline: 'Tidak Aktif',
                checking: 'Memeriksa...',
                error: 'Error'
            };
            
            textEl.textContent = statusText[status] || 'Unknown';
            
            // Update lab status text
            if (labStatusEl) {
                labStatusEl.textContent = status === 'online' ? 'üü¢ Aktif' : 
                                         status === 'offline' ? 'üî¥ Tidak Aktif' : 
                                         status === 'checking' ? 'üü° Memeriksa' : '‚ö´ Error';
            }
            
            // Update internet status
            if (internetStatusEl) {
                internetStatusEl.textContent = status === 'online' ? 'Online' : 
                                              status === 'offline' ? 'Offline' : '-';
            }
            
            if (lastUpdateEl) {
                const now = new Date();
                lastUpdateEl.textContent = now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }

        function setButtonsEnabled(enabled) {
            const btnOn = safeGetElement('btn-on');
            const btnOff = safeGetElement('btn-off');
            const btnDevices = safeGetElement('btn-devices');
            
            if (btnOn) btnOn.disabled = !enabled;
            if (btnOff) btnOff.disabled = !enabled;
            if (btnDevices) btnDevices.disabled = !enabled;
        }

        function switchTab(tabName) {
            AppState.currentTab = tabName;
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                tab.classList.remove('active');
                if ((index === 0 && tabName === 'control') ||
                    (index === 1 && tabName === 'devices')) {
                    tab.classList.add('active');
                }
            });
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = safeGetElement(`tab-${tabName}`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // Load data for devices tab
            if (tabName === 'devices') {
                loadDevices();
            }
        }

        // ==========================================
        // API FUNCTIONS
        // ==========================================

        async function testConnection() {
            try {
                console.log('üîç Testing connection...');
                
                const response = await fetchWithTimeout(
                    `${CONFIG.PYTHON_SERVER_URL}/status`,
                    { method: 'GET' },
                    5000
                );
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Connected');
                    updateServerConnection(true);
                    AppState.retryCount = 0;
                    return true;
                }
                
                console.error('‚ùå Server error:', response.status);
                updateServerConnection(false);
                return false;
            } catch (error) {
                console.error('‚ùå Connection error:', error.message);
                updateServerConnection(false);
                return false;
            }
        }

        async function loadLabData() {
            try {
                const response = await fetchWithTimeout(`${CONFIG.PYTHON_SERVER_URL}/labs`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.labs) {
                        const lab = data.labs.find(l => l.id === CONFIG.LAB_ID);
                        if (lab) {
                            // Data loaded but not displayed for security
                            console.log('Lab data loaded');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading lab data:', error);
            }
        }

        async function checkStatus() {
            if (!AppState.isServerConnected) {
                updateStatus('error');
                return;
            }

            try {
                const response = await fetchWithTimeout(
                    `${CONFIG.PYTHON_SERVER_URL}/lab/status/${CONFIG.LAB_ID}`,
                    { method: 'GET' }
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.status) {
                        updateStatus(data.status);
                    } else {
                        updateStatus('error');
                    }
                } else {
                    updateStatus('error');
                }
            } catch (error) {
                console.error('Error checking status:', error);
                updateStatus('error');
            }
        }

        async function toggleInternet(action) {
            const actionText = action === 'on' ? 'menghidupkan' : 'mematikan';

            if (!AppState.isServerConnected) {
                showToast('Server Tidak Tersedia', 'Tidak dapat terhubung ke server kontrol', 'error');
                return;
            }

            if (!confirm(`Apakah Anda yakin ingin ${actionText} internet di ${CONFIG.LAB_NAME}?`)) {
                return;
            }

            showLoading(`${actionText.charAt(0).toUpperCase() + actionText.slice(1)} internet...`);
            setButtonsEnabled(false);

            try {
                const response = await fetchWithTimeout(
                    `${CONFIG.PYTHON_SERVER_URL}/lab/internet`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lab_id: CONFIG.LAB_ID,
                            action: action
                        })
                    }
                );

                hideLoading();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    showToast('Berhasil', `Internet berhasil di-${action} untuk ${CONFIG.LAB_NAME}`, 'success');
                    updateStatus(action === 'on' ? 'online' : 'offline');
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (error) {
                hideLoading();
                console.error('Toggle error:', error);
                showToast('Gagal', `Gagal ${actionText} internet: ${error.message}`, 'error');
            } finally {
                setButtonsEnabled(true);
            }
        }

        async function loadDevices() {
            showLoading('Memuat data devices...');
            
            try {
                const response = await fetchWithTimeout(
                    `${CONFIG.PYTHON_SERVER_URL}/lab/devices/${CONFIG.LAB_ID}`
                );

                hideLoading();

                if (!response.ok) {
                    throw new Error('Failed to fetch devices');
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Unknown error');
                }

                // Update device count
                const countEl = safeGetElement('device-count');
                const deviceCountStatusEl = safeGetElement('deviceCountStatus');
                const activeDevicesInfoEl = safeGetElement('active-devices-info');
                
                if (countEl) {
                    countEl.textContent = data.active_devices || 0;
                }
                if (deviceCountStatusEl) {
                    deviceCountStatusEl.textContent = data.active_devices || 0;
                }
                if (activeDevicesInfoEl) {
                    activeDevicesInfoEl.textContent = `${data.active_devices || 0} / ${data.total_devices || 0}`;
                }

                // Update stats
                const totalDevicesEl = safeGetElement('total-devices');
                const totalActiveEl = safeGetElement('total-active');

                if (totalDevicesEl) totalDevicesEl.textContent = data.total_devices || 0;
                if (totalActiveEl) totalActiveEl.textContent = data.active_devices || 0;

                // Build devices list
                const devices = data.devices || [];
                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                let html = `
                    <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; text-align: center;">
                        <div style="font-size: 14px; opacity: 0.9;">
                            üîÑ Last updated: ${timeString} ‚Ä¢ Auto-refresh: ON
                        </div>
                    </div>
                `;

                if (devices.length === 0) {
                    html += `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div class="empty-state-text">Tidak ada devices terdeteksi</div>
                            <div style="margin-top: 10px; color: #999; font-size: 14px;">
                                Pastikan ada komputer yang terhubung ke lab ini
                            </div>
                        </div>
                    `;
                } else {
                    html += `<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">`;

                    devices.forEach((device) => {
                        const statusBg = device.active ? '#e8f5e9' : '#ffebee';
                        const statusColor = device.active ? '#2e7d32' : '#c62828';
                        const statusIcon = device.active ? 'üü¢' : 'üî¥';
                        const statusText = device.active ? 'Online' : 'Offline';
                        
                        let deviceIcon = 'üíª';
                        const hostname = (device.hostname || 'unknown').toLowerCase();
                        if (hostname.includes('phone') || hostname.includes('android') || hostname.includes('iphone')) {
                            deviceIcon = 'üì±';
                        } else if (hostname.includes('laptop')) {
                            deviceIcon = 'üíª';
                        } else if (hostname.includes('pc') || hostname.includes('desktop')) {
                            deviceIcon = 'üñ•Ô∏è';
                        } else if (hostname.includes('tablet') || hostname.includes('ipad')) {
                            deviceIcon = 'üì±';
                        }

                        html += `
                            <div style="background: white; border-radius: 12px; padding: 20px; border: 2px solid ${device.active ? '#4caf50' : '#e0e0e0'}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="font-size: 32px;">${deviceIcon}</div>
                                    <div style="background: ${statusBg}; color: ${statusColor}; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 5px;">
                                        <span>${statusIcon}</span>
                                        <span>${statusText}</span>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <div style="font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; margin-bottom: 3px;">Hostname</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #333; word-break: break-word;">
                                        ${device.hostname || 'Unknown Device'}
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                                    <div>
                                        <div style="font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; margin-bottom: 3px;">IP Address</div>
                                        <div style="font-size: 13px; font-weight: 600; color: #f093fb; font-family: 'Courier New', monospace;">
                                            ${device.ip}
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; margin-bottom: 3px;">Source</div>
                                        <div style="font-size: 13px; font-weight: 600; color: #333;">
                                            ${device.source || 'N/A'}
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                                    <div style="font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; margin-bottom: 3px;">MAC Address</div>
                                    <div style="font-size: 12px; font-family: 'Courier New', monospace; color: #666; word-break: break-all;">
                                        ${device.mac || 'N/A'}
                                    </div>
                                </div>

                                ${device.last_seen ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
                                        <div style="font-size: 11px; color: #999; text-transform: uppercase; font-weight: 600; margin-bottom: 3px;">Last Seen</div>
                                        <div style="font-size: 12px; color: #666;">
                                            ${device.last_seen}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });

                    html += `</div>`;
                }

                const devicesList = safeGetElement('devices-list');
                if (devicesList) {
                    devicesList.innerHTML = html;
                }

            } catch (error) {
                hideLoading();
                console.error('Error loading devices:', error);
                showToast('Error', `Gagal memuat devices: ${error.message}`, 'error');
            }
        }

        // ==========================================
        // AUTO-REFRESH
        // ==========================================

        async function autoRefresh() {
            if (!AppState.isServerConnected) return;

            if (AppState.currentTab === 'devices') {
                await loadDevices();
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        async function init() {
            console.log(`üéØ Initializing ${CONFIG.LAB_NAME} Dashboard...`);
            
            const connected = await testConnection();
            
            if (connected) {
                await loadLabData();
                await checkStatus();
                await loadDevices();
                
                // Setup auto-refresh
                setInterval(async () => {
                    if (AppState.isServerConnected) {
                        await checkStatus();
                        await loadDevices();
                        await autoRefresh();
                    }
                }, CONFIG.CHECK_INTERVAL);
                
                showToast('Dashboard Siap', `${CONFIG.LAB_NAME} terhubung ‚Ä¢ Auto-refresh: ON`, 'success');
            } else {
                setButtonsEnabled(false);
                updateStatus('error');
                
                if (AppState.retryCount < CONFIG.MAX_RETRIES) {
                    AppState.retryCount++;
                    setTimeout(testConnection, 5000);
                }
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================

        document.addEventListener('DOMContentLoaded', init);

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && AppState.isServerConnected) {
                checkStatus();
                loadDevices();
            }
        });

        window.addEventListener('online', testConnection);
        window.addEventListener('offline', () => updateServerConnection(false));
    </script>
</body>
</html>